{% load static %}

{% load i18n %}

<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Required meta tags-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="au theme template">
    <meta name="author" content="Hau Nguyen">
    <meta name="keywords" content="au theme template">

    <!-- Title Page-->
      <title>
        Todo App - 
        {% block title %}
            page_title
        {% endblock %}
    </title>

    <!-- Fontfaces CSS-->
    <link href="{% static 'css/font-face.css' %}" rel="stylesheet" media="all">
    <link href="{% static 'vendor/font-awesome-4.7/css/font-awesome.min.css' %}" rel="stylesheet" media="all">
    <link href="{% static 'vendor/font-awesome-5/css/fontawesome-all.min.css' %}" rel="stylesheet" media="all">
    <link href="{% static 'vendor/mdi-font/css/material-design-iconic-font.min.css' %}" rel="stylesheet" media="all">

    <!-- Bootstrap CSS-->
    <link href=" {% static 'vendor/bootstrap-4.1/bootstrap.min.css' %}" rel="stylesheet" media="all">

    <!-- Vendor CSS-->
    <link href=" {% static 'vendor/animsition/animsition.min.css' %}" rel="stylesheet" media="all">
    <link href=" {% static 'vendor/bootstrap-progressbar/bootstrap-progressbar-3.3.4.min.css' %}" rel="stylesheet" media="all">
    <link href=" {% static 'vendor/wow/animate.css' %}" rel="stylesheet" media="all">
    <link href=" {% static 'vendor/css-hamburgers/hamburgers.min.css' %}" rel="stylesheet" media="all">
    <link href=" {% static 'vendor/slick/slick.css' %}" rel="stylesheet" media="all">
    <link href=" {% static 'vendor/select2/select2.min.css' %}" rel="stylesheet" media="all">
    <link href=" {% static 'vendor/perfect-scrollbar/perfect-scrollbar.css' %}" rel="stylesheet" media="all">

    <!-- Main CSS-->
    <link href="{% static 'css/theme.css' %}" rel="stylesheet" media="all">
    
    {% block page_style_and_script %}
    {% endblock page_style_and_script %}

</head>

<body class="animsition">
    <div class="page-wrapper">
        <!-- MENU SIDEBAR-->
        <aside class="menu-sidebar2">
            <div class="logo">
                <a href="{% url 'dashboard' %}">
                    <img src="{% static 'images/icon/logo-white.png' %}" alt="Cool Admin" />
                </a>
            </div>
            <div class="menu-sidebar2__content js-scrollbar1">
                {% include 'inc/nav.html' %}
            </div>
        </aside>
        <!-- END MENU SIDEBAR-->

        <!-- PAGE CONTAINER-->
        <div class="page-container2">
            <!-- HEADER DESKTOP-->
            <header class="header-desktop2">
                <div class="section__content section__content--p30">
                    <div class="container-fluid">
                        <div class="header-wrap2">
                            <div class="logo d-block d-lg-none">
                                <a href="{% url 'dashboard' %}">
                                    <img src="{% static 'images/icon/logo-white.png' %} " alt="CoolAdmin" />
                                </a>
                            </div>
                                <div class="header-button2">
                                <div class="header-button-item js-item-menu">
                                    <i class="zmdi zmdi-search"></i>
                                    <div class="search-dropdown js-dropdown">
                                        <form action="">
                                            <input class="au-input au-input--full au-input--h65" id="grand_search" type="text" placeholder='{% trans "plh_search_todos_users_workspaces" %}' />
                                            <span class="search-dropdown__icon">
                                                <a href="{% url 'search_result' %}" id="go">
                                                <i class="zmdi zmdi-search"></i>
                                                </a>
                                            </span>
                                        </form>
                                    </div>
                                </div>
                                <div class="header-button-item js-item-menu" id="has_noti">
                                    <i class="zmdi zmdi-notifications"></i>
                                    <div class="notifi-dropdown js-dropdown">
                                        <div class="notifi__title">
                                            <p>{% trans "text_you_have" %} <span id="notification_count"></span> {% trans "text_notifications" %}</p>
                                        </div>
                                        <div id="notification_list">
                                        </div>
                                        <div class="notifi__footer">
                                            <a href="{% url 'notifications.unread' %}">{% trans "text_all_notifications" %}</a>
                                        </div>
                                    </div>
                                </div>
                                <div class="header-button-item mr-0 js-sidebar-btn">
                                    <i class="zmdi zmdi-menu"></i>
                                </div>
                                <div class="setting-menu js-right-sidebar d-none d-lg-block">
                                    <div class="account-dropdown__body">
                                        <div class="account-dropdown__item">
                                            <a href="#">
                                                <i class="zmdi zmdi-account"></i>Account</a>
                                        </div>
                                        <div class="account-dropdown__item">
                                            <a href="#">
                                                <i class="zmdi zmdi-settings"></i>Setting</a>
                                        </div>
                                        <div class="account-dropdown__item">
                                            <a href="#">
                                                <i class="zmdi zmdi-money-box"></i>Billing</a>
                                        </div>
                                    </div>
                                    <div class="account-dropdown__body">
                                        <div class="account-dropdown__item">
                                            <a href="{% url 'language.change' %}?next={{request.path}}">
                                                <i class="zmdi zmdi-globe"></i>Language</a>
                                        </div>
                                        <div class="account-dropdown__item">
                                            <a href="#">
                                                <i class="zmdi zmdi-pin"></i>Location</a>
                                        </div>
                                        <div class="account-dropdown__item">
                                            <a href="#">
                                                <i class="zmdi zmdi-email"></i>Email</a>
                                        </div>
                                        <div class="account-dropdown__item">
                                            <a href="#">
                                                <i class="zmdi zmdi-notifications"></i>Notifications</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                        
            </header>

             <aside class="menu-sidebar2 js-right-sidebar d-block d-lg-none">
                <div class="logo">
                    <a href="{% url 'dashboard' %}">
                        <img src="{% static 'images/icon/logo-white.png' %}" alt="Cool Admin" />
                    </a>
                </div>
                <div class="menu-sidebar2__content js-scrollbar2">
                    {% include 'inc/nav.html' %}
                </div>
            </aside> 
            <!-- END HEADER DESKTOP-->

            <!-- BREADCRUMB-->
            <section class="au-breadcrumb m-t-75">
                <div class="section__content section__content--p30">
                    <div class="container-fluid">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="au-breadcrumb-content">
                                    <div class="au-breadcrumb-left">
                                        <span class="au-breadcrumb-span">You are here:</span>
                                        <ul class="list-unstyled list-inline au-breadcrumb__list">
                                            <li class="list-inline-item active">
                                                <a href="#">{% trans "title_dashboard" %}</a>
                                            </li>                                         
                                            {% block breadcrumb %}

                                            {% if path %}
                                            
                                                {% block path %}
                                                <li class="list-inline-item seprate">
                                                    <span>/</span>
                                                </li>
                                                <li class="list-inline-item"> 
                                                    Dashboard{% trans "title_dashboard" %}
                                                </li>                                                    
                                                {% endblock path %}
                                                
                                            {% endif %}
                                                    
                                            {% endblock %}
                                        </ul>
                                    </div>
                                    <a href="{% url 'todos.create' %}?next={{request.path}}" class="au-btn au-btn-icon au-btn--green text-light">
                                        <i class="zmdi zmdi-plus"></i>{% trans "btn_new_todo" %}
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <!-- END BREADCRUMB-->
            
            <!-- STATISTIC-->
            <section class="statistic">
                <div class="section__content section__content--p30">
                    <div class="container-fluid">
                        {% if message %}
                        <div class="row">
                            <div class="col">
                                <p class="alert alert-success">
                                    {{message}}
                                </p>
                            </div>
                        </div>
                        {% endif %}
                        <div class="row">
                            <div class="col">                         
                                {% block content %}
                                {% endblock %}
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <!-- END STATISTIC-->

            <section>
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="copyright">
                                <p>{% trans "text_copy_right" %} © {% now 'Y' %} Cool Todo. {% trans "text_all_rights_reserved" %}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <!-- END PAGE CONTAINER-->
        </div>

    </div>

    <!-- Jquery JS-->
    {% comment %} <script src="{% static 'vendor/jquery-3.2.1.min.js' %}"></script> {% endcomment %}
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <!-- Bootstrap JS-->
    <script src="{% static 'vendor/bootstrap-4.1/popper.min.js' %}"></script>
    <script src="{% static 'vendor/bootstrap-4.1/bootstrap.min.js' %}"></script>
    <!-- Vendor JS       -->
    <script src="{% static 'vendor/slick/slick.min.js' %}">
    </script>
    <script src="{% static 'vendor/wow/wow.min.js' %}"></script>
    <script src="{% static 'vendor/animsition/animsition.min.js' %}"></script>
    <script src="{% static 'vendor/bootstrap-progressbar/bootstrap-progressbar.min.js' %}">
    </script>
    <script src="{% static 'vendor/counter-up/jquery.waypoints.min.js' %}"></script>
    <script src="{% static 'vendor/counter-up/jquery.counterup.min.js' %}">
    </script>
    <script src="{% static 'vendor/circle-progress/circle-progress.min.js' %}"></script>
    <script src="{% static 'vendor/perfect-scrollbar/perfect-scrollbar.js' %}"></script>
    <script src="{% static 'vendor/chartjs/Chart.bundle.min.js' %}"></script>
    <script src="{% static 'vendor/select2/select2.min.js' %}">
    </script>

    <!-- Main JS-->
    <script src="{% static 'js/main.js' %}"></script>

    {% if CURRENT_WORKSPACE %}

    <script>
        $(document).ready(function() {
            function updateNotificationBadge() {
                $.ajax({
                    url: "{% url 'get_count_todos' %}",
                    success: function(data) {
                        $('#shared_in_badge').text(data.shared_in);
                        $('#shared_out_badge').text(data.shared_out);
                        $('#pending_badge').text(data.pending);
                    }
                });
            }
            
            updateNotificationBadge();
            
            setInterval(updateNotificationBadge, 180000); // update every minute
            
            function listNotifications() {
                $.ajax({
                    url: "{% url 'notification-list' %}",
                    success: function(data) {
                        let count = data.length
                        if (count > 0) {
                            $('#has_noti').addClass("has-noti");
                        }
                         $('#notification_count').text(data.length);
                         for (let i=0; i<data.length; i++){
                            let itemData = data[i];
                            let item = `<div class="notifi__item" onclick="window.location.href = '{% url 'notifications.unread' %}'">
                                            <div class="bg-c3 img-cir img-40">
                                                <i class="zmdi zmdi-file-text"></i>
                                            </div>
                                            <div class="content">
                                                <p>${itemData.message.substring(4, 30)}</p>
                                                <span class="date">${itemData.created_at}</span>
                                            </div>
                                        </div>`;
                            $('#notification_list').append(item);
                         }
                    }
                });
            }
            
            listNotifications();

        });
        
        $(function () {
            $('[data-toggle="popover"]').popover()
        })

        $('.popover-dismiss').popover({
            trigger: 'focus'
        })
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
  
  <script>
    $(document).ready(function() {
        $('#grand_search').autocomplete({
            source: function(request, response) {
                $.ajax({
                    url: "{% url 'grand_search' %}",
                    data: {
                        'keyword': request.term
                    },
                    dataType: 'json',
                    success: function(data) {
                        response(data);
                    }
                });
            },
            minLength: 3,
            select: function(event, ui) {
                // When an item is selected, set the hidden field with the post ID
                location.href="{% url 'search_result' %}"+'?type='+ui.item.type+'&id='+ui.item.id;
            }
        });
    });
  </script>

  <script>
    // Register the service worker in your main JavaScript file
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/firebase-messaging-sw.js')
            .then((registration) => {
                console.log("Service Worker registered with scope:", registration.scope);
            })
            .catch((error) => {
                console.error("Service Worker registration failed:", error);
            });
    }
</script>

<!-- Firebase App (required) -->
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<!-- Firebase Messaging (required for FCM) -->
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-messaging-compat.js"></script>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyAPE-nwaHWcCQJy3CmH9jWv8jCZFYXna9s",
      authDomain: "todo-app-11873.firebaseapp.com",
      projectId: "todo-app-11873",
      storageBucket: "todo-app-11873.appspot.com",
      messagingSenderId: "1029086662942",
      appId: "1:1029086662942:web:df169f068e8bd520a6790f",
      measurementId: "G-NKHQ8GP41Z"
    };
    
    firebase.initializeApp(firebaseConfig);
    
    // Get messaging instance
    const messaging = firebase.messaging();

    // Function to get FCM token
    function getFcmToken() {
            messaging.getToken({ vapidKey: 'BKQtJ6fOK8kFQ78d80TrZCd_zYOLcVbdl6A5fcXStKeFqktK9i4-mAUbH8eUOPdNUou51vwtYCBKRs2xehD-aHc' })
            .then((currentToken) => {
            if (currentToken) {
                console.log('FCM Token received.');
                saveFcmToken(currentToken);
            } else {
                console.warn('No FCM token received.');
                return null;
            }
        })
        .catch((error) => {
            console.error('Error getting FCM token:', error);
        });
    }

    function saveFcmToken(fcmToken) {
        if (fcmToken) {
            $.ajax({
                url: '{% url "save_fcm_token" %}',
                type: 'POST',
                data: { 
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                    fcm_token: fcmToken, 
                },
                dataType: 'json',
                success: function(response) {
                    console.log('FCM token saved successfully:', response);
                },
                error: function(error) {
                    console.error('Error saving FCM token:', error);
                }
            });
        }
    }

    getFcmToken();

  </script>

    {% endif %}
    
    {% block page_bottom_script %}
    {% endblock %}        

</body>

</html>
<!-- end document-->
